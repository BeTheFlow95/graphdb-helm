NAME: graphdb-ee
LAST DEPLOYED: Tue Mar 30 11:48:46 2021
NAMESPACE: default
STATUS: pending-install
REVISION: 1
TEST SUITE: None
HOOKS:
MANIFEST:
---
# Source: gdb-ee/templates/configuration/graphdb-master-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: graphdb-master-1-configmap
  labels:
    name: graphdb-master-1-configmap
data:
  # >- means replace new line with space and no new lines at the end
  GDB_JAVA_OPTS: >-
    -Denable-context-index=true
    -Dentity-pool-implementation=transactional
    -Dhealth.max.query.time.seconds=60
    -Dgraphdb.vhosts=http://graphdb.local/graphdb,
    -Dgraphdb.append.request.id.headers=true
    -Dgraphdb.workbench.importDirectory=/opt/graphdb/home/graphdb-import
    -Dgraphdb.auth.token.secret="s3cr37"
     -Xmx4G -XX:MaxRAMPercentage=70 -XX:+UseContainerSupport
---
# Source: gdb-ee/templates/configuration/graphdb-master-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: graphdb-master-2-configmap
  labels:
    name: graphdb-master-2-configmap
data:
  # >- means replace new line with space and no new lines at the end
  GDB_JAVA_OPTS: >-
    -Denable-context-index=true
    -Dentity-pool-implementation=transactional
    -Dhealth.max.query.time.seconds=60
    -Dgraphdb.vhosts=http://graphdb.local/graphdb-master-2,
    -Dgraphdb.append.request.id.headers=true
    -Dgraphdb.workbench.importDirectory=/opt/graphdb/home/graphdb-import
    -Dgraphdb.auth.token.secret="s3cr37"
     -Xmx4G -XX:MaxRAMPercentage=70 -XX:+UseContainerSupport
---
# Source: gdb-ee/templates/configuration/graphdb-master-repo-default-configmap.yaml
# Default configuration map for provisioning GraphDB repository.
# To change it, prepare another configuration map and update "graphdb.repositoryConfigmap"
apiVersion: v1
kind: ConfigMap
metadata:
  name: graphdb-repo-default-configmap
  labels:
    name: graphdb-repo-default-configmap
data:
  config.ttl: |-

    #
    # RDF4J configuration template for a GraphDB EE worker repository
    #
    @prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#>.
    @prefix rep: <http://www.openrdf.org/config/repository#>.
    @prefix sr: <http://www.openrdf.org/config/repository/sail#>.
    @prefix sail: <http://www.openrdf.org/config/sail#>.
    @prefix owlim: <http://www.ontotext.com/trree/owlim#>.
    
    [] a rep:Repository ;
        rep:repositoryID "test" ;
        rdfs:label "GraphDB master for test" ;
        rep:repositoryImpl [
            rep:repositoryType "owlim:ReplicationCluster" ;
        ].
---
# Source: gdb-ee/templates/configuration/graphdb-worker-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: graphdb-worker-1-configmap
  labels:
    name: graphdb-worker-1-configmap
data:
  # >- means replace new line with space and no new lines at the end
  GDB_JAVA_OPTS: >-
    -Denable-context-index=true
    -Dentity-pool-implementation=transactional
    -Dhealth.max.query.time.seconds=60
    -Dgraphdb.vhosts=http://graphdb.local/graphdb-worker-1
    -Dgraphdb.append.request.id.headers=true
    -Dgraphdb.auth.token.secret="s3cr37"
     -Xmx2G -XX:MaxRAMPercentage=70 -XX:+UseContainerSupport
---
# Source: gdb-ee/templates/configuration/graphdb-worker-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: graphdb-worker-2-configmap
  labels:
    name: graphdb-worker-2-configmap
data:
  # >- means replace new line with space and no new lines at the end
  GDB_JAVA_OPTS: >-
    -Denable-context-index=true
    -Dentity-pool-implementation=transactional
    -Dhealth.max.query.time.seconds=60
    -Dgraphdb.vhosts=http://graphdb.local/graphdb-worker-2
    -Dgraphdb.append.request.id.headers=true
    -Dgraphdb.auth.token.secret="s3cr37"
     -Xmx1G -XX:MaxRAMPercentage=70 -XX:+UseContainerSupport
---
# Source: gdb-ee/templates/configuration/graphdb-worker-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: graphdb-worker-3-configmap
  labels:
    name: graphdb-worker-3-configmap
data:
  # >- means replace new line with space and no new lines at the end
  GDB_JAVA_OPTS: >-
    -Denable-context-index=true
    -Dentity-pool-implementation=transactional
    -Dhealth.max.query.time.seconds=60
    -Dgraphdb.vhosts=http://graphdb.local/graphdb-worker-3
    -Dgraphdb.append.request.id.headers=true
    -Dgraphdb.auth.token.secret="s3cr37"
     -Xmx2G -XX:MaxRAMPercentage=70 -XX:+UseContainerSupport
---
# Source: gdb-ee/templates/configuration/graphdb-worker-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: graphdb-worker-4-configmap
  labels:
    name: graphdb-worker-4-configmap
data:
  # >- means replace new line with space and no new lines at the end
  GDB_JAVA_OPTS: >-
    -Denable-context-index=true
    -Dentity-pool-implementation=transactional
    -Dhealth.max.query.time.seconds=60
    -Dgraphdb.vhosts=http://graphdb.local/graphdb-worker-4
    -Dgraphdb.append.request.id.headers=true
    -Dgraphdb.auth.token.secret="s3cr37"
     -Xmx2G -XX:MaxRAMPercentage=70 -XX:+UseContainerSupport
---
# Source: gdb-ee/templates/configuration/graphdb-worker-repo-default-configmap.yaml
# Default configuration map for provisioning GraphDB worker node repository.
# To change it, prepare another configuration map and update "graphdb.cluster.worker.repositoryConfigmap"
apiVersion: v1
kind: ConfigMap
metadata:
  name: graphdb-worker-repo-default-configmap
  labels:
    name: graphdb-worker-repo-default-configmap
data:
  config.ttl: |-
    #
    # RDF4J configuration template for a GraphDB EE worker repository
    #
    @prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#>.
    @prefix rep: <http://www.openrdf.org/config/repository#>.
    @prefix sr: <http://www.openrdf.org/config/repository/sail#>.
    @prefix sail: <http://www.openrdf.org/config/sail#>.
    @prefix owlim: <http://www.ontotext.com/trree/owlim#>.
    @prefix shacl: <http://rdf4j.org/config/sail/shacl#>.
    
    [] a rep:Repository ;
        rep:repositoryID "test" ;
        rdfs:label "GraphDB worker for test" ;
        rep:repositoryImpl [
            rep:repositoryType "owlim:ReplicationClusterWorker" ;
            rep:delegate [
                rep:repositoryType "owlim:MonitorRepository" ;
                sr:sailImpl [
                    sail:sailType "rdf4j:ShaclSail";
                    shacl:validationEnabled "true" ;
                    shacl:logValidationPlans "false" ;
                    shacl:logValidationViolations "false" ;
                    shacl:parallelValidation "true" ;
                    shacl:globalLogValidationExecution "false" ;
                    shacl:cacheSelectNodes "true" ;
                    shacl:undefinedTargetValidatesAllSubjects "false" ;
                    shacl:ignoreNoShapesLoadedException "false" ;
                    shacl:performanceLogging "false" ;
                    shacl:rdfsSubClassReasoning "true" ;
                    shacl:shaclAdvancedFeatures "true" ;
                    shacl:dashDataShapes "true" ;
                    sail:delegate [
                      sail:sailType "owlimClusterWorker:Sail";
                      owlim:owlim-license "" ;
                      owlim:base-URL "http://example.org/owlim#" ;
                      owlim:defaultNS "" ;
                      owlim:entity-index-size "10000000" ;
                      owlim:entity-id-size  "32" ;
                      owlim:imports "" ;
                      owlim:repository-type "file-repository" ;
                      owlim:ruleset "rdfsplus-optimized" ;
                      owlim:storage-folder "storage" ;
                      owlim:enable-context-index "false" ;
                      owlim:enablePredicateList "true" ;
                      owlim:in-memory-literal-properties "true" ;
                      owlim:enable-literal-index "true" ;
                      owlim:check-for-inconsistencies "false" ;
                      owlim:disable-sameAs  "true" ;
                      owlim:query-timeout  "0" ;
                      owlim:query-limit-results  "0" ;
                      owlim:throw-QueryEvaluationException-on-timeout "false" ;
                      owlim:read-only "false" ;
                      owlim:nonInterpretablePredicates "http://www.w3.org/2000/01/rdf-schema#label;http://www.w3.org/1999/02/22-rdf-syntax-ns#type;http://www.ontotext.com/owlim/ces#gazetteerConfig;http://www.ontotext.com/owlim/ces#metadataConfig" ;
                    ]
                ]
            ]
        ].
---
# Source: gdb-ee/templates/configuration/kong-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: kong-configmap
  labels:
    app: kong-configmap
data:
  KONG_DATABASE: "off"
  KONG_DECLARATIVE_CONFIG: "/etc/kong/kong.yaml"
  KONG_MEM_CACHE_SIZE: "64m"
  KONG_NGINX_WORKER_PROCESSES: "auto"
  KONG_ADMIN_LISTEN: "0.0.0.0:8001, 0.0.0.0:8444 ssl"
  KONG_PROXY_ACCESS_LOG: "/dev/stdout"
  KONG_ADMIN_ACCESS_LOG: "/dev/stdout"
  KONG_PROXY_ERROR_LOG: "/dev/stderr"
  KONG_ADMIN_ERROR_LOG: "/dev/stderr"
---
# Source: gdb-ee/templates/configuration/kong-services-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: kong-services-configmap
  labels:
    app: kong-services-configmap
data:
  kong.yaml: |-
    # Some notes before digging into this configuration
    # This is Kong's DB less configuration, i.e. this work without a database.
    # The configuration is static and Kong cannot be customized without providing a new declarative configuration.
    # See more at https://docs.konghq.com/2.0.x/db-less-and-declarative-config/
    #
    # This file is prepared for Helm chart templates.
    # See https://helm.sh/docs/chart_template_guide/control_structures/
    #
    # Note: to validate this configuration without running the chart, use
    # docker run -it --rm -v $(pwd):/tmp/files -e KONG_DATABASE=off kong:2.1-alpine kong config parse /tmp/files/kong.dbless.yaml
    
    _format_version: "1.1"
    
    plugins:
      # Refer to https://docs.konghq.com/hub/kong-inc/correlation-id/
      # This is configured to trigger for all services/routes and to return it to the client.
      - name: correlation-id
        config:
          # Match the one used by semantic objects
          header_name: X-Request-ID
          generator: uuid
          # Make Kong return the header to the clients
          echo_downstream: true
    
    services:
      - name: graphdb-master-1
        url: http://graphdb-master-1:7200
        connect_timeout: 60000
        read_timeout: 60000
        write_timeout: 60000
        routes:
          - name: graphdb-master-1
            paths: ["/graphdb"]
            methods: ["GET", "POST", "PUT", "DELETE"]
            strip_path: true
            preserve_host: false
    
      # 
      - name: graphdb-master-2
        url: http://graphdb-master-2:7200
        connect_timeout: 60000
        read_timeout: 60000
        write_timeout: 60000
        routes:
          - name: graphdb-master-2
            paths: ["/graphdb-master-2"]
            methods: ["GET", "POST", "PUT", "DELETE"]
            strip_path: true
            preserve_host: false
      # 
    
      # 
      # 
      - name: graphdb-worker-1
        url: http://graphdb-worker-1:7200
        connect_timeout: 60000
        read_timeout: 60000
        write_timeout: 60000
        routes:
          - name: graphdb-worker-1
            paths: ["/graphdb-worker-1"]
            methods: ["GET", "POST", "PUT", "DELETE"]
            strip_path: true
            preserve_host: false
      # 
      - name: graphdb-worker-2
        url: http://graphdb-worker-2:7200
        connect_timeout: 60000
        read_timeout: 60000
        write_timeout: 60000
        routes:
          - name: graphdb-worker-2
            paths: ["/graphdb-worker-2"]
            methods: ["GET", "POST", "PUT", "DELETE"]
            strip_path: true
            preserve_host: false
      # 
      - name: graphdb-worker-3
        url: http://graphdb-worker-3:7200
        connect_timeout: 60000
        read_timeout: 60000
        write_timeout: 60000
        routes:
          - name: graphdb-worker-3
            paths: ["/graphdb-worker-3"]
            methods: ["GET", "POST", "PUT", "DELETE"]
            strip_path: true
            preserve_host: false
      # 
      - name: graphdb-worker-4
        url: http://graphdb-worker-4:7200
        connect_timeout: 60000
        read_timeout: 60000
        write_timeout: 60000
        routes:
          - name: graphdb-worker-4
            paths: ["/graphdb-worker-4"]
            methods: ["GET", "POST", "PUT", "DELETE"]
            strip_path: true
            preserve_host: false
      #  range
      #  cluster & expose check
---
# Source: gdb-ee/templates/graphdb-utils-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: graphdb-utils-configmap
  labels:
    name: graphdb-utils-configmap
data:
  graphdb.sh: |-
    #!/usr/bin/env bash
    
    set -eu
    
    #TODO: Add a function which sets a master as read only
    function waitService() {
      address=$1
    
      attempt_counter=0
      max_attempts=100
    
      echo "Waiting for ${address}"
      until $(curl --output /dev/null --silent --fail ${address}); do
        if [[ ${attempt_counter} -eq ${max_attempts} ]];then
          echo "Max attempts reached"
          exit 1
        fi
    
        printf '.'
        attempt_counter=$(($attempt_counter+1))
        sleep 5
      done
    }
    
    waitMasters() {
      masters_count=$1
      master_repo=$2
    
      for (( c=1; c<=$masters_count; c++ ))
      do
        master_address=http://graphdb-master-$c:7200
        waitService "${master_address}/rest/repositories"
        waitService "${master_address}/rest/repositories/${master_repo}/size"
        waitService "${master_address}/rest/cluster/masters/${master_repo}"
      done
    }
    
    waitWorkers() {
      workers_count=$1
      workers_repo=$2
    
      for (( c=1; c<=$workers_count; c++ ))
      do
        workers_address=http://graphdb-worker-$c:7200
        waitService "${workers_address}/rest/repositories"
        waitService "${workers_address}/rest/repositories/${workers_repo}/size"
      done
    }
    
    linkWorkerToMaster() {
      master_address=http://$1:7200
      master_repo=$2
      worker_address=http://$3:7200
      worker_repository=$4
    
      worker_repo_endpoint="${worker_address}/repositories/${worker_repository}"
      waitService "${worker_address}/rest/repositories"
      waitService "${worker_address}/rest/repositories/${worker_repository}/size"
    
      waitService "${master_address}/rest/repositories"
      waitService "${master_address}/rest/repositories/${worker_repository}/size"
    
      addInstanceAsRemoteLocation $1 $3
    
      echo "Linking worker with repo endpoint ${worker_repo_endpoint}"
      curl -o response.json -sf -X POST ${master_address}/jolokia/ \
        --header 'Content-Type: multipart/form-data' \
        --data-raw "{
          \"type\": \"exec\",
          \"mbean\": \"ReplicationCluster:name=ClusterInfo/${master_repo}\",
          \"operation\": \"addClusterNode\",
          \"arguments\": [
            \"${worker_repo_endpoint}\", 0, true
          ]
        }"
       if grep -q '"status":200' "response.json"; then
          echo "Linking successfull for worker $worker_address"
      else
          echo "Linking failed for worker ${worker_address}"
          exit 1
      fi
    
      echo "Worker linked successfully!"
    }
    
    setInstanceReadOnly() {
      instance_address=http://$1:7200
      repository=$2
    
      echo "Setting instance $instance_address as readonly"
    
      curl -o response.json -H 'content-type: application/json' -d "{\"type\":\"write\",\"mbean\":\"ReplicationCluster:name=ClusterInfo\/$repository\",\"attribute\":\"ReadOnly\",\"value\":true}" $instance_address/jolokia
    
      if grep -q '"status":200' "response.json"; then
          echo "Successfully set instance $instance_address as read only"
      else
          echo "Failed setting instance read only $instance_address"
          exit 1
      fi
    }
    
    setInstanceMuted() {
      instance_address=http://$1:7200
      repository=$2
    
      echo "Setting instance $instance_address as muted"
    
      curl -o response.json -H 'content-type: application/json' -d "{\"type\":\"write\",\"mbean\":\"ReplicationCluster:name=ClusterInfo\/$repository\",\"attribute\":\"Mode\",\"value\":\"MUTE\"}" $instance_address/jolokia/
    
      if grep -q '"status":200' "response.json"; then
          echo "Successfully set instance $instance_address as muted"
      else
          echo "Failed setting instance muted $instance_address"
          exit 1
      fi
    }
    
    addInstanceAsRemoteLocation() {
      master_address=http://$1:7200
      worker_address=http://$2:7200
    
      echo "Adding worker $worker_address as remote location of $master_address"
    
      curl ${master_address}/rest/locations -o response.json -H 'Content-Type:application/json' -H 'Accept: application/json, text/plain, */*' --data-raw "{\"uri\":\"${worker_address}\",\"username\":\"\", \"password\":\"\", \"active\":\"false\"}"
    
      if grep -q 'Success\|connected' "response.json"; then
          echo "Successfully added $worker_address as remote location of $master_address"
      else
          echo "Failed adding instance $worker_address as remote location of $master_address"
          exit 1
      fi
    }
    
    setSyncPeer() {
      instance1_address=http://$1:7200
      instance2_address=http://$3:7200
      instance1_repository=$2
      instance2_repository=$4
    
      addInstanceAsRemoteLocation $1 $3
    
      echo "Setting $instance2_address as sync pear for $instance1_address"
    
      curl -o response.json -H 'content-type: application/json' -d "{\"type\":\"exec\",\"mbean\":\"ReplicationCluster:name=ClusterInfo\/$instance1_repository\",\"operation\":\"addSyncPeer\",\"arguments\":[\"$instance2_address/repositories/$instance2_repository\",\"$instance2_address/repositories/$instance2_repository\"]}"   $instance1_address/jolokia/
      if grep -q '"status":200' "response.json"; then
          echo "Successfully set sync peer between $instance1_address and $instance2_address"
      else
          echo "Failed setting sync peer between $instance1_address and $instance2_address"
          exit 1
      fi
    }
    
    linkAllWorkersToMaster() {
      worker_repository=$4
      master_repo=$2
      workers_count=$3
      for (( c=1; c<=$workers_count; c++ ))
      do
        worker_address=graphdb-worker-$c
        linkWorkerToMaster $1 $master_repo $worker_address $worker_repository
      done
    
      echo "Cluster linked successfully!"
    }
    
    waitAllInstances() {
      #workersCount, workerRepo
      waitWorkers $3 $4
      #mastersCount, mastersRepo
      waitMasters $1 $2
    }
    
    link_1m_3w() {
      #masters count, master repo, workers count, worker repo
      waitAllInstances $1 $2 $3 $4
    
      #1 master, multiple workers. Args: master to link to, master repo, workers count, workers repo
      linkAllWorkersToMaster graphdb-master-1 $2 $3 $4
    }
    
    "$@"
---
# Source: gdb-ee/templates/persistence/graphdb-master-default-pv.yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: graphdb-master-default-master-1-pv
  labels:
    name: graphdb-master-default-master-1-pv
spec:
  storageClassName: "standard"
  accessModes:
    - ReadWriteOnce
  capacity:
    storage: 10G
  hostPath:
    path: /data/graphdb-master-1-data


#
# Default persistence volume for GraphDB workers. Data is stored on the node file system. Suitable
# for Minikube deployments.
#
# Note: Not to be used in production or multi node cluster.
#
---
# Source: gdb-ee/templates/persistence/graphdb-master-default-pv.yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: graphdb-master-default-master-2-pv
  labels:
    name: graphdb-master-default-master-2-pv
spec:
  storageClassName: "standard"
  accessModes:
    - ReadWriteOnce
  capacity:
    storage: 10G
  hostPath:
    path: /data/graphdb-master-2-data
---
# Source: gdb-ee/templates/persistence/graphdb-worker-default-pv.yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: graphdb-worker-default-worker-1-pv
  labels:
    name: graphdb-worker-default-worker-1-pv
spec:
  storageClassName: "standard"
  accessModes:
    - ReadWriteOnce
  capacity:
    storage: 10G
  hostPath:
    path: /data/graphdb-worker-1-data


#
# Default persistence volume for GraphDB workers. Data is stored on the node file system. Suitable
# for Minikube deployments.
#
# Note: Not to be used in production or multi node cluster.
#
---
# Source: gdb-ee/templates/persistence/graphdb-worker-default-pv.yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: graphdb-worker-default-worker-2-pv
  labels:
    name: graphdb-worker-default-worker-2-pv
spec:
  storageClassName: "standard"
  accessModes:
    - ReadWriteOnce
  capacity:
    storage: 10G
  hostPath:
    path: /data/graphdb-worker-2-data


#
# Default persistence volume for GraphDB workers. Data is stored on the node file system. Suitable
# for Minikube deployments.
#
# Note: Not to be used in production or multi node cluster.
#
---
# Source: gdb-ee/templates/persistence/graphdb-worker-default-pv.yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: graphdb-worker-default-worker-3-pv
  labels:
    name: graphdb-worker-default-worker-3-pv
spec:
  storageClassName: "standard"
  accessModes:
    - ReadWriteOnce
  capacity:
    storage: 10G
  hostPath:
    path: /data/graphdb-worker-3-data


#
# Default persistence volume for GraphDB workers. Data is stored on the node file system. Suitable
# for Minikube deployments.
#
# Note: Not to be used in production or multi node cluster.
#
---
# Source: gdb-ee/templates/persistence/graphdb-worker-default-pv.yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: graphdb-worker-default-worker-4-pv
  labels:
    name: graphdb-worker-default-worker-4-pv
spec:
  storageClassName: "standard"
  accessModes:
    - ReadWriteOnce
  capacity:
    storage: 10G
  hostPath:
    path: /data/graphdb-worker-4-data
---
# Source: gdb-ee/templates/persistence/graphdb-master-pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: graphdb-master-1-data-pvc
  labels:
    name: graphdb-master-1-data-pvc
spec:
  volumeName:  graphdb-master-default-master-1-pv
  storageClassName: standard
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10G
---
# Source: gdb-ee/templates/persistence/graphdb-master-pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: graphdb-master-2-data-pvc
  labels:
    name: graphdb-master-2-data-pvc
spec:
  volumeName:  graphdb-master-default-master-2-pv
  storageClassName: standard
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10G
---
# Source: gdb-ee/templates/persistence/graphdb-worker-pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: graphdb-worker-1-data-pvc
  labels:
    name: graphdb-worker-1-data-pvc
spec:
  volumeName: graphdb-worker-default-worker-1-pv
  storageClassName: standard
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10G
---
# Source: gdb-ee/templates/persistence/graphdb-worker-pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: graphdb-worker-2-data-pvc
  labels:
    name: graphdb-worker-2-data-pvc
spec:
  volumeName: graphdb-worker-default-worker-2-pv
  storageClassName: standard
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10G
---
# Source: gdb-ee/templates/persistence/graphdb-worker-pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: graphdb-worker-3-data-pvc
  labels:
    name: graphdb-worker-3-data-pvc
spec:
  volumeName: graphdb-worker-default-worker-3-pv
  storageClassName: standard
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10G
---
# Source: gdb-ee/templates/persistence/graphdb-worker-pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: graphdb-worker-4-data-pvc
  labels:
    name: graphdb-worker-4-data-pvc
spec:
  volumeName: graphdb-worker-default-worker-4-pv
  storageClassName: standard
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10G
---
# Source: gdb-ee/templates/gateway/kong.yaml
apiVersion: v1
kind: Service
metadata:
  name: kong-proxy
spec:
  selector:
    app: kong
  ports:
    - name: kong-proxy
      port: 8000
      targetPort: 8000
      protocol: TCP
---
# Source: gdb-ee/templates/gateway/kong.yaml
apiVersion: v1
kind: Service
metadata:
  name: kong-proxy-ssl
spec:
  selector:
    app: kong
  ports:
    - name: kong-proxy-ssl
      port: 8443
      targetPort: 8443
      protocol: TCP
---
# Source: gdb-ee/templates/gateway/kong.yaml
apiVersion: v1
kind: Service
metadata:
  name: kong-admin
spec:
  selector:
    app: kong
  ports:
    - name: kong-admin
      port: 8001
      targetPort: 8001
      protocol: TCP
---
# Source: gdb-ee/templates/gateway/kong.yaml
apiVersion: v1
kind: Service
metadata:
  name: kong-admin-ssl
spec:
  selector:
    app: kong
  ports:
    - name: kong-admin-ssl
      port: 8444
      targetPort: 8444
      protocol: TCP
---
# Source: gdb-ee/templates/gateway/kong.yaml
apiVersion: v1
kind: Service
metadata:
  name: kong-admin-outside
spec:
  selector:
    app: kong
  type: NodePort
  ports:
    - name: kong-admin-outside
      nodePort: 31122
      port: 8001
      protocol: TCP
      targetPort: 8001
  sessionAffinity: None
status:
  loadBalancer: {}
---
# Source: gdb-ee/templates/graphdb-master.yaml
apiVersion: v1
kind: Service
metadata:
  name: graphdb-master-1
  labels:
    app: graphdb-master-1
spec:
  selector:
    app: graphdb-master-1
  ports:
    - name: graphdb-master-1
      port: 7200
      targetPort: 7200
      protocol: TCP
---
# Source: gdb-ee/templates/graphdb-master.yaml
apiVersion: v1
kind: Service
metadata:
  name: graphdb-master-2
  labels:
    app: graphdb-master-2
spec:
  selector:
    app: graphdb-master-2
  ports:
    - name: graphdb-master-2
      port: 7200
      targetPort: 7200
      protocol: TCP
---
# Source: gdb-ee/templates/graphdb-worker.yaml
apiVersion: v1
kind: Service
metadata:
  name: graphdb-worker-1
  labels:
    app: graphdb-worker-1
spec:
  selector:
    app: graphdb-worker-1
  ports:
    - name: graphdb-worker-1
      port: 7200
      targetPort: 7200
      protocol: TCP
---
# Source: gdb-ee/templates/graphdb-worker.yaml
apiVersion: v1
kind: Service
metadata:
  name: graphdb-worker-2
  labels:
    app: graphdb-worker-2
spec:
  selector:
    app: graphdb-worker-2
  ports:
    - name: graphdb-worker-2
      port: 7200
      targetPort: 7200
      protocol: TCP
---
# Source: gdb-ee/templates/graphdb-worker.yaml
apiVersion: v1
kind: Service
metadata:
  name: graphdb-worker-3
  labels:
    app: graphdb-worker-3
spec:
  selector:
    app: graphdb-worker-3
  ports:
    - name: graphdb-worker-3
      port: 7200
      targetPort: 7200
      protocol: TCP
---
# Source: gdb-ee/templates/graphdb-worker.yaml
apiVersion: v1
kind: Service
metadata:
  name: graphdb-worker-4
  labels:
    app: graphdb-worker-4
spec:
  selector:
    app: graphdb-worker-4
  ports:
    - name: graphdb-worker-4
      port: 7200
      targetPort: 7200
      protocol: TCP
---
# Source: gdb-ee/templates/gateway/kong.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kong
  labels:
    app: kong
spec:
  replicas: 1
  selector:
    matchLabels:
      app: kong
  template:
    metadata:
      name: kong
      labels:
        app: kong
      annotations:
        # Enables redeployment if the configuration map or the declarative configuration is updated
        checksum/configmap: 327ac5b93a30f3a005b17c6642d22d4df61d725f8a5f3904ab7910e308db337b
        checksum/services-configmap: bd561ffd85732adcd497354c45ef61716af21c1e62cdda088f77b2a9cb41b5ee
    spec:
      volumes:
        - name: kong-services-config
          configMap:
            name: kong-services-configmap
      
      nodeSelector: 
        {}
      
      containers:
        - name: kong
          image: kong:2.1-alpine
          imagePullPolicy: IfNotPresent
          envFrom:
            - configMapRef:
                name: kong-configmap
          ports:
            - name: proxy
              containerPort: 8000
              protocol: TCP
            - name: proxy-ssl
              containerPort: 8443
              protocol: TCP
            - name: admin
              containerPort: 8001
              protocol: TCP
            - name: admin-ssl
              containerPort: 8444
              protocol: TCP
          volumeMounts:
            - name: kong-services-config
              mountPath: /etc/kong
          resources: 
            limits:
              memory: 2048Mi
          readinessProbe:
            exec:
              command: ["kong", "health"]
            initialDelaySeconds: 5
            periodSeconds: 10
          livenessProbe:
            exec:
              command: ["kong", "health"]
            initialDelaySeconds: 5
            periodSeconds: 10
---
# Source: gdb-ee/templates/graphdb-master.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: graphdb-master-1
  labels:
    app: graphdb-master-1
spec:
  replicas: 1
  # Important to define this strategy instead of the default rolling update, otherwise when
  # performing helm update, GraphDB won't release its lock from the repositories and the new
  # pod won't be able to start.
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: graphdb-master-1
  template:
    metadata:
      labels:
        app: graphdb-master-1
    spec:
      terminationGracePeriodSeconds: 60
      volumes:
        - name: graphdb-master-license
          secret:
            secretName: graphdb-masters-license
        - name: graphdb-master-storage
          persistentVolumeClaim:
            claimName: graphdb-master-1-data-pvc
        - name: graphdb-master-repo-config
          configMap:
            name: graphdb-repo-default-configmap
      
      
      nodeSelector: 
        {}
      
      containers:
        - name: graphdb-master-1
          image: docker-registry.ontotext.com/graphdb-ee:9.8.0-HOSTS-TR2-adoptopenjdk11
          imagePullPolicy: IfNotPresent
          ports:
            - name: graphdb-m-1
              containerPort: 7200
          envFrom:
            - configMapRef:
                name: graphdb-master-1-configmap
          volumeMounts:
            - name: graphdb-master-storage
              mountPath: /opt/graphdb/home
          resources: 
            limits:
              memory: 4Gi
            requests:
              memory: 2Gi
          # Allow for GraphDB to start within 10*30 seconds before readiness & liveness probes interfere
          startupProbe:
            httpGet:
              path: /repositories
              port: graphdb-m-1
            failureThreshold: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /repositories
              port: graphdb-m-1
            initialDelaySeconds: 5
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /repositories
              port: graphdb-m-1
            initialDelaySeconds: 60
            periodSeconds: 10
      initContainers:
        # LICENSE PROVISION
        - name: provision-license
          image: busybox:1.31
          imagePullPolicy: IfNotPresent
          volumeMounts:
            - name: graphdb-master-storage
              mountPath: /opt/graphdb/home
            - name: graphdb-master-license
              mountPath: /tmp/license/
          command: ['sh', '-c']
          args:
            - |
                mkdir -p /opt/graphdb/home/conf/
                cd /opt/graphdb/home/conf/
                [ -f graphdb.license ] && echo "License present, exiting..." && exit 0

                echo 'Provisioning GraphDB master 1 license'
                cp /tmp/license/graphdb.license ./graphdb.license
                echo 'Done'
        # REPO PROVISION
        - name: provision-repository
          image: busybox:1.31
          imagePullPolicy: IfNotPresent
          volumeMounts:
            - name: graphdb-master-storage
              mountPath: /opt/graphdb/home
            - name: graphdb-master-repo-config
              mountPath: /tmp/graphdb
          command: ['sh', '-c']
          args:
            - |
              set -eu
              mkdir -p /opt/graphdb/home/data/repositories/test ;
              cd /opt/graphdb/home/data/repositories/test ;

              # If the repo configuration exists -> skip provisioning
              [ -f config.ttl ] && echo "Repository exists, exiting..." && exit 0

              echo 'Provisioning GraphDB test repository config.ttl' ;
              cp /tmp/graphdb/config.ttl ./config.ttl ;
              echo 'Done'
---
# Source: gdb-ee/templates/graphdb-master.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: graphdb-master-2
  labels:
    app: graphdb-master-2
spec:
  replicas: 1
  # Important to define this strategy instead of the default rolling update, otherwise when
  # performing helm update, GraphDB won't release its lock from the repositories and the new
  # pod won't be able to start.
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: graphdb-master-2
  template:
    metadata:
      labels:
        app: graphdb-master-2
    spec:
      terminationGracePeriodSeconds: 60
      volumes:
        - name: graphdb-master-license
          secret:
            secretName: graphdb-masters-license
        - name: graphdb-master-storage
          persistentVolumeClaim:
            claimName: graphdb-master-2-data-pvc
        - name: graphdb-master-repo-config
          configMap:
            name: graphdb-repo-default-configmap
      
      
      nodeSelector: 
        {}
      
      containers:
        - name: graphdb-master-2
          image: docker-registry.ontotext.com/graphdb-ee:9.8.0-HOSTS-TR2-adoptopenjdk11
          imagePullPolicy: IfNotPresent
          ports:
            - name: graphdb-m-2
              containerPort: 7200
          envFrom:
            - configMapRef:
                name: graphdb-master-2-configmap
          volumeMounts:
            - name: graphdb-master-storage
              mountPath: /opt/graphdb/home
          resources: 
            limits:
              memory: 4Gi
            requests:
              memory: 2Gi
          # Allow for GraphDB to start within 10*30 seconds before readiness & liveness probes interfere
          startupProbe:
            httpGet:
              path: /repositories
              port: graphdb-m-2
            failureThreshold: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /repositories
              port: graphdb-m-2
            initialDelaySeconds: 5
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /repositories
              port: graphdb-m-2
            initialDelaySeconds: 60
            periodSeconds: 10
      initContainers:
        # LICENSE PROVISION
        - name: provision-license
          image: busybox:1.31
          imagePullPolicy: IfNotPresent
          volumeMounts:
            - name: graphdb-master-storage
              mountPath: /opt/graphdb/home
            - name: graphdb-master-license
              mountPath: /tmp/license/
          command: ['sh', '-c']
          args:
            - |
                mkdir -p /opt/graphdb/home/conf/
                cd /opt/graphdb/home/conf/
                [ -f graphdb.license ] && echo "License present, exiting..." && exit 0

                echo 'Provisioning GraphDB master 2 license'
                cp /tmp/license/graphdb.license ./graphdb.license
                echo 'Done'
        # REPO PROVISION
        - name: provision-repository
          image: busybox:1.31
          imagePullPolicy: IfNotPresent
          volumeMounts:
            - name: graphdb-master-storage
              mountPath: /opt/graphdb/home
            - name: graphdb-master-repo-config
              mountPath: /tmp/graphdb
          command: ['sh', '-c']
          args:
            - |
              set -eu
              mkdir -p /opt/graphdb/home/data/repositories/test ;
              cd /opt/graphdb/home/data/repositories/test ;

              # If the repo configuration exists -> skip provisioning
              [ -f config.ttl ] && echo "Repository exists, exiting..." && exit 0

              echo 'Provisioning GraphDB test repository config.ttl' ;
              cp /tmp/graphdb/config.ttl ./config.ttl ;
              echo 'Done'
---
# Source: gdb-ee/templates/graphdb-worker.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: graphdb-worker-1
  labels:
    app: graphdb-worker-1
spec:
  replicas: 1
  # Important to define this strategy instead of the default rolling update, otherwise when
  # performing helm update, GraphDB won't release its lock from the repositories and the new
  # pod won't be able to start.
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: graphdb-worker-1
  template:
    metadata:
      labels:
        app: graphdb-worker-1
    spec:
      terminationGracePeriodSeconds: 60
      volumes:
        - name: graphdb-license
          secret:
            secretName: graphdb-worker1-license
        - name: graphdb-worker-storage
          persistentVolumeClaim:
            claimName: graphdb-worker-1-data-pvc
        - name: graphdb-worker-repo-config
          configMap:
            name: graphdb-worker-repo-default-configmap
        - name: graphdb-utils
          configMap:
            name: graphdb-utils-configmap
      
      
      nodeSelector: 
        {}
      
      containers:
        - name: graphdb-worker-1
          image: docker-registry.ontotext.com/graphdb-ee:9.8.0-HOSTS-TR2-adoptopenjdk11
          imagePullPolicy: IfNotPresent
          ports:
            - name: graphdb-w-1
              containerPort: 7200
          envFrom:
            - configMapRef:
                name: graphdb-worker-1-configmap
          volumeMounts:
            - name: graphdb-worker-storage
              mountPath: /opt/graphdb/home
          resources: 
            limits:
              memory: 4Gi
            requests:
              memory: 2Gi
          # Allow for GraphDB to start within 10*30 seconds before readiness & liveness probes interfere
          startupProbe:
            httpGet:
              path: /repositories
              port: graphdb-w-1
            failureThreshold: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /repositories
              port: graphdb-w-1
            initialDelaySeconds: 5
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /repositories
              port: graphdb-w-1
            initialDelaySeconds: 10
            periodSeconds: 10
      initContainers:
        # LICENSE PROVISION
        - name: provision-license
          image: busybox:1.31
          imagePullPolicy: IfNotPresent
          volumeMounts:
            - name: graphdb-worker-storage
              mountPath: /opt/graphdb/home
            - name: graphdb-license
              mountPath: /tmp/license/
          command: ['sh', '-c']
          args:
            - |
                mkdir -p /opt/graphdb/home/conf/
                cd /opt/graphdb/home/conf/
                [ -f graphdb.license ] && echo "License present, exiting..." && exit 0

                echo 'Provisioning GraphDB worker 1 license'
                cp /tmp/license/graphdb.license ./graphdb.license
                echo 'Done'
        # REPO PROVISION
        - name: provision-worker-repository
          image: busybox:1.31
          imagePullPolicy: IfNotPresent
          volumeMounts:
            - name: graphdb-worker-storage
              mountPath: /opt/graphdb/home
            - name: graphdb-worker-repo-config
              mountPath: /tmp/graphdb
          command: ['sh', '-c']
          args:
            - |
              set -eu
              mkdir -p /opt/graphdb/home/data/repositories/test ;
              cd /opt/graphdb/home/data/repositories/test ;

              # If the repo configuration exists -> skip provisioning
              [ -f config.ttl ] && echo "Repository exists, exiting..." && exit 0

              echo 'Provisioning GraphDB test repository config.ttl' ;
              cp /tmp/graphdb/config.ttl ./config.ttl ;
              echo 'Done'
---
# Source: gdb-ee/templates/graphdb-worker.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: graphdb-worker-2
  labels:
    app: graphdb-worker-2
spec:
  replicas: 1
  # Important to define this strategy instead of the default rolling update, otherwise when
  # performing helm update, GraphDB won't release its lock from the repositories and the new
  # pod won't be able to start.
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: graphdb-worker-2
  template:
    metadata:
      labels:
        app: graphdb-worker-2
    spec:
      terminationGracePeriodSeconds: 60
      volumes:
        - name: graphdb-license
          secret:
            secretName: graphdb-workers-license
        - name: graphdb-worker-storage
          persistentVolumeClaim:
            claimName: graphdb-worker-2-data-pvc
        - name: graphdb-worker-repo-config
          configMap:
            name: graphdb-worker-repo-default-configmap
        - name: graphdb-utils
          configMap:
            name: graphdb-utils-configmap
      
      
      nodeSelector: 
        {}
      
      containers:
        - name: graphdb-worker-2
          image: docker-registry.ontotext.com/graphdb-ee:9.8.0-HOSTS-TR2-adoptopenjdk11
          imagePullPolicy: IfNotPresent
          ports:
            - name: graphdb-w-2
              containerPort: 7200
          envFrom:
            - configMapRef:
                name: graphdb-worker-2-configmap
          volumeMounts:
            - name: graphdb-worker-storage
              mountPath: /opt/graphdb/home
          resources: 
            limits:
              memory: 4Gi
            requests:
              memory: 2Gi
          # Allow for GraphDB to start within 10*30 seconds before readiness & liveness probes interfere
          startupProbe:
            httpGet:
              path: /repositories
              port: graphdb-w-2
            failureThreshold: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /repositories
              port: graphdb-w-2
            initialDelaySeconds: 5
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /repositories
              port: graphdb-w-2
            initialDelaySeconds: 10
            periodSeconds: 10
      initContainers:
        # LICENSE PROVISION
        - name: provision-license
          image: busybox:1.31
          imagePullPolicy: IfNotPresent
          volumeMounts:
            - name: graphdb-worker-storage
              mountPath: /opt/graphdb/home
            - name: graphdb-license
              mountPath: /tmp/license/
          command: ['sh', '-c']
          args:
            - |
                mkdir -p /opt/graphdb/home/conf/
                cd /opt/graphdb/home/conf/
                [ -f graphdb.license ] && echo "License present, exiting..." && exit 0

                echo 'Provisioning GraphDB worker 2 license'
                cp /tmp/license/graphdb.license ./graphdb.license
                echo 'Done'
        # REPO PROVISION
        - name: provision-worker-repository
          image: busybox:1.31
          imagePullPolicy: IfNotPresent
          volumeMounts:
            - name: graphdb-worker-storage
              mountPath: /opt/graphdb/home
            - name: graphdb-worker-repo-config
              mountPath: /tmp/graphdb
          command: ['sh', '-c']
          args:
            - |
              set -eu
              mkdir -p /opt/graphdb/home/data/repositories/test ;
              cd /opt/graphdb/home/data/repositories/test ;

              # If the repo configuration exists -> skip provisioning
              [ -f config.ttl ] && echo "Repository exists, exiting..." && exit 0

              echo 'Provisioning GraphDB test repository config.ttl' ;
              cp /tmp/graphdb/config.ttl ./config.ttl ;
              echo 'Done'
---
# Source: gdb-ee/templates/graphdb-worker.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: graphdb-worker-3
  labels:
    app: graphdb-worker-3
spec:
  replicas: 1
  # Important to define this strategy instead of the default rolling update, otherwise when
  # performing helm update, GraphDB won't release its lock from the repositories and the new
  # pod won't be able to start.
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: graphdb-worker-3
  template:
    metadata:
      labels:
        app: graphdb-worker-3
    spec:
      terminationGracePeriodSeconds: 60
      volumes:
        - name: graphdb-license
          secret:
            secretName: graphdb-workers-license
        - name: graphdb-worker-storage
          persistentVolumeClaim:
            claimName: graphdb-worker-3-data-pvc
        - name: graphdb-worker-repo-config
          configMap:
            name: graphdb-worker-repo-default-configmap
        - name: graphdb-utils
          configMap:
            name: graphdb-utils-configmap
      
      
      nodeSelector: 
        {}
      
      containers:
        - name: graphdb-worker-3
          image: docker-registry.ontotext.com/graphdb-ee:9.8.0-HOSTS-TR2-adoptopenjdk11
          imagePullPolicy: IfNotPresent
          ports:
            - name: graphdb-w-3
              containerPort: 7200
          envFrom:
            - configMapRef:
                name: graphdb-worker-3-configmap
          volumeMounts:
            - name: graphdb-worker-storage
              mountPath: /opt/graphdb/home
          resources: 
            limits:
              memory: 4Gi
            requests:
              memory: 2Gi
          # Allow for GraphDB to start within 10*30 seconds before readiness & liveness probes interfere
          startupProbe:
            httpGet:
              path: /repositories
              port: graphdb-w-3
            failureThreshold: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /repositories
              port: graphdb-w-3
            initialDelaySeconds: 5
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /repositories
              port: graphdb-w-3
            initialDelaySeconds: 10
            periodSeconds: 10
      initContainers:
        # LICENSE PROVISION
        - name: provision-license
          image: busybox:1.31
          imagePullPolicy: IfNotPresent
          volumeMounts:
            - name: graphdb-worker-storage
              mountPath: /opt/graphdb/home
            - name: graphdb-license
              mountPath: /tmp/license/
          command: ['sh', '-c']
          args:
            - |
                mkdir -p /opt/graphdb/home/conf/
                cd /opt/graphdb/home/conf/
                [ -f graphdb.license ] && echo "License present, exiting..." && exit 0

                echo 'Provisioning GraphDB worker 3 license'
                cp /tmp/license/graphdb.license ./graphdb.license
                echo 'Done'
        # REPO PROVISION
        - name: provision-worker-repository
          image: busybox:1.31
          imagePullPolicy: IfNotPresent
          volumeMounts:
            - name: graphdb-worker-storage
              mountPath: /opt/graphdb/home
            - name: graphdb-worker-repo-config
              mountPath: /tmp/graphdb
          command: ['sh', '-c']
          args:
            - |
              set -eu
              mkdir -p /opt/graphdb/home/data/repositories/test ;
              cd /opt/graphdb/home/data/repositories/test ;

              # If the repo configuration exists -> skip provisioning
              [ -f config.ttl ] && echo "Repository exists, exiting..." && exit 0

              echo 'Provisioning GraphDB test repository config.ttl' ;
              cp /tmp/graphdb/config.ttl ./config.ttl ;
              echo 'Done'
---
# Source: gdb-ee/templates/graphdb-worker.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: graphdb-worker-4
  labels:
    app: graphdb-worker-4
spec:
  replicas: 1
  # Important to define this strategy instead of the default rolling update, otherwise when
  # performing helm update, GraphDB won't release its lock from the repositories and the new
  # pod won't be able to start.
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: graphdb-worker-4
  template:
    metadata:
      labels:
        app: graphdb-worker-4
    spec:
      terminationGracePeriodSeconds: 60
      volumes:
        - name: graphdb-license
          secret:
            secretName: graphdb-workers-license
        - name: graphdb-worker-storage
          persistentVolumeClaim:
            claimName: graphdb-worker-4-data-pvc
        - name: graphdb-worker-repo-config
          configMap:
            name: graphdb-worker-repo-default-configmap
        - name: graphdb-utils
          configMap:
            name: graphdb-utils-configmap
      
      
      nodeSelector: 
        {}
      
      containers:
        - name: graphdb-worker-4
          image: docker-registry.ontotext.com/graphdb-ee:9.8.0-HOSTS-TR2-adoptopenjdk11
          imagePullPolicy: IfNotPresent
          ports:
            - name: graphdb-w-4
              containerPort: 7200
          envFrom:
            - configMapRef:
                name: graphdb-worker-4-configmap
          volumeMounts:
            - name: graphdb-worker-storage
              mountPath: /opt/graphdb/home
          resources: 
            limits:
              memory: 4Gi
            requests:
              memory: 2Gi
          # Allow for GraphDB to start within 10*30 seconds before readiness & liveness probes interfere
          startupProbe:
            httpGet:
              path: /repositories
              port: graphdb-w-4
            failureThreshold: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /repositories
              port: graphdb-w-4
            initialDelaySeconds: 5
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /repositories
              port: graphdb-w-4
            initialDelaySeconds: 10
            periodSeconds: 10
      initContainers:
        # LICENSE PROVISION
        - name: provision-license
          image: busybox:1.31
          imagePullPolicy: IfNotPresent
          volumeMounts:
            - name: graphdb-worker-storage
              mountPath: /opt/graphdb/home
            - name: graphdb-license
              mountPath: /tmp/license/
          command: ['sh', '-c']
          args:
            - |
                mkdir -p /opt/graphdb/home/conf/
                cd /opt/graphdb/home/conf/
                [ -f graphdb.license ] && echo "License present, exiting..." && exit 0

                echo 'Provisioning GraphDB worker 4 license'
                cp /tmp/license/graphdb.license ./graphdb.license
                echo 'Done'
        # REPO PROVISION
        - name: provision-worker-repository
          image: busybox:1.31
          imagePullPolicy: IfNotPresent
          volumeMounts:
            - name: graphdb-worker-storage
              mountPath: /opt/graphdb/home
            - name: graphdb-worker-repo-config
              mountPath: /tmp/graphdb
          command: ['sh', '-c']
          args:
            - |
              set -eu
              mkdir -p /opt/graphdb/home/data/repositories/test ;
              cd /opt/graphdb/home/data/repositories/test ;

              # If the repo configuration exists -> skip provisioning
              [ -f config.ttl ] && echo "Repository exists, exiting..." && exit 0

              echo 'Provisioning GraphDB test repository config.ttl' ;
              cp /tmp/graphdb/config.ttl ./config.ttl ;
              echo 'Done'
---
# Source: gdb-ee/templates/post-start-job.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: link-graphdb-cluster
spec:
  template:
    spec:
      containers:
        - name: pi
          image: docker-registry.ontotext.com/graphdb-ee:9.8.0-HOSTS-TR2-adoptopenjdk11
          securityContext:
            allowPrivilegeEscalation: false
            runAsUser: 0
          volumeMounts:
            - name: graphdb-utils
              mountPath: /tmp/utils
          command: ['sh','-c']
          args:
            - |
                cp /tmp/utils/graphdb.sh /usr/local/bin/graphdb.sh; chmod +x /usr/local/bin/graphdb.sh ;
                /usr/local/bin/graphdb.sh waitAllInstances 2 "test" 4 "test";
                  /usr/local/bin/graphdb.sh setInstanceReadOnly graphdb-master-2 "test";

                
                  
                    /usr/local/bin/graphdb.sh linkWorkerToMaster graphdb-master-1 "test" graphdb-worker-1 "test";
                    /usr/local/bin/graphdb.sh linkWorkerToMaster graphdb-master-1 "test" graphdb-worker-2 "test";
                    /usr/local/bin/graphdb.sh linkWorkerToMaster graphdb-master-1 "test" graphdb-worker-3 "test";
                    /usr/local/bin/graphdb.sh linkWorkerToMaster graphdb-master-1 "test" graphdb-worker-4 "test";
                  
                    /usr/local/bin/graphdb.sh linkWorkerToMaster graphdb-master-2 "test" graphdb-worker-1 "test";
                    /usr/local/bin/graphdb.sh linkWorkerToMaster graphdb-master-2 "test" graphdb-worker-2 "test";
                    /usr/local/bin/graphdb.sh linkWorkerToMaster graphdb-master-2 "test" graphdb-worker-3 "test";
                    /usr/local/bin/graphdb.sh linkWorkerToMaster graphdb-master-2 "test" graphdb-worker-4 "test";
                  /usr/local/bin/graphdb.sh setSyncPeer graphdb-master-1 "test" graphdb-master-2 "test";
                  /usr/local/bin/graphdb.sh setSyncPeer graphdb-master-2 "test" graphdb-master-1 "test";
                >> /proc/1/fd/1
      restartPolicy: Never
      volumes:
        - name: graphdb-utils
          configMap:
            name: graphdb-utils-configmap
  backoffLimit: 4
---
# Source: gdb-ee/templates/gateway/ingress.yaml
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: ingress
  annotations:
    kubernetes.io/ingress.class: "nginx"
    
    nginx.ingress.kubernetes.io/proxy-body-size: 512M
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "5"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "60"

spec:
  
  rules:
    - host: "graphdb.local"
      http:
        paths:
          - path: /
            backend:
              serviceName: kong-proxy
              servicePort: 8000
---
# Source: gdb-ee/templates/graphdb-master.yaml
# Loop over the replica count
---
# Source: gdb-ee/templates/graphdb-worker.yaml
# Loop over the replica count
---
# Source: gdb-ee/templates/persistence/graphdb-master-default-pv.yaml
#
# Default persistence volume for GraphDB workers. Data is stored on the node file system. Suitable
# for Minikube deployments.
#
# Note: Not to be used in production or multi node cluster.
#
---
# Source: gdb-ee/templates/persistence/graphdb-worker-default-pv.yaml
#
# Default persistence volume for GraphDB workers. Data is stored on the node file system. Suitable
# for Minikube deployments.
#
# Note: Not to be used in production or multi node cluster.
#

NOTES:
--------------------------------------------------------------------------------------------
   ____                 _     ____  ____      _____ _____
  / ___|_ __ __ _ _ __ | |__ |  _ \| __ )    | ____| ____|
 | |  _| '__/ _` | '_ \| '_ \| | | |  _ \    |  _| |  _|
 | |_| | | | (_| | |_) | | | | |_| | |_) |   | |___| |___
  \____|_|  \__,_| .__/|_| |_|____/|____/    |_____|_____|
                 |_|
--------------------------------------------------------------------------------------------
version: 9.5.0
GDB cluster: true

** Please be patient while the chart is being deployed and services are available **
You can check their status with kubectl get pods

Endpoints:
* GraphDB workbench: http://graphdb.local/graphdb
